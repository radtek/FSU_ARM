/*
 * protocolX.cpp
 *
 *  Created on: 2016-5-26
 *      Author: lcz
 */
#include <unistd.h>
#include <stdio.h>
#include <dlfcn.h>
#include "AppConfig.h"
#include "DevComDatParse.h"


PFN_PreHdl f1;
PFN_CRC f2;

char s1[] = {49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,
		49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,
		49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,
		49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,
		49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,
		49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,
		49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,
		49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,
		49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,
		49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,
		49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,
		49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,
		49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,
		49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,
		0};
char s2[] = {50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,
		50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,
		50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,
		50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,
		50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,
		50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,
		50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,
		50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,
		50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,
		50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,
		50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,
		50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,
		50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,
		50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,
		0};

//auto af1 = [f1,s1](void *)->void *{while(1){(*f1)((char*)s1);return ((void *) 0);}};
//auto af2 = [f1,s2](void *)->void *{while(1){(*f1)((char*)s2);return ((void *) 0);}};
void* af1(void*) {
	while(1){
		(*f1)((char*)s1);
		usleep(10000);
	}
	return ((void *) 0);
}
void* af2(void*) {
	while(1){
		(*f1)((char*)s2);
		usleep(10000);
	}
	return ((void *) 0);
}

void dlLoadTest() {
    char path[256];
    string p = get_exe_path(path, 256)+ string("libp13633.so");
    void * hDynLib = 0;
    hDynLib = dlopen(p.c_str(), RTLD_LAZY);

    if (hDynLib) {
    	f1 = (PFN_PreHdl)dlsym(hDynLib, "preHdl");
    	f2 = (PFN_CRC)dlsym(hDynLib, "crc");
    	(*f1)(path);
    	(*f2)(path);
    }
    int ret;
    pthread_t tid1;
    pthread_t tid2;
    ret = pthread_create(&tid1, NULL,
    		af1,
    		NULL);
    if (ret != 0) {
    	cout << "create thread error!" << endl;
    	exit(1);
    }
    ret = pthread_create(&tid2, NULL,
    		af2,
    		NULL);
    if (ret != 0) {
    	cout << "create thread error!" << endl;
    	exit(1);
    }
}



